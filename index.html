<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家用品庫存管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Serif TC', serif; }
        .font-sans { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-[#F7F5F2] text-[#4A443F]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 安全存取工具 ---
        const safeStorage = {
            get: (key, defaultValue) => {
                try {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : defaultValue;
                } catch (e) {
                    console.warn("Storage access denied.");
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.warn("Storage write denied.");
                }
            }
        };

        // --- 圖示組件 ---
        const Icon = ({ name, size = 20, className = "", strokeWidth = 2 }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const App = () => {
            const apiKey = ""; // API Key 由環境注入或手動填寫

            // --- 狀態管理 ---
            const [items, setItems] = useState(() => safeStorage.get('home_inv_v2_items', []));
            const [history, setHistory] = useState(() => safeStorage.get('home_inv_v2_history', []));
            const [activeTab, setActiveTab] = useState('inventory');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [detailItem, setDetailItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [notification, setNotification] = useState(null);
            
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [aiModalOpen, setAiModalOpen] = useState(false);
            const [aiTitle, setAiTitle] = useState('');

            const fileInputRef = useRef(null);
            const [newItem, setNewItem] = useState({ name: '', quantity: 0, minQuantity: 1, unit: '個', notes: '' });

            // --- 自動儲存 ---
            useEffect(() => {
                safeStorage.set('home_inv_v2_items', items);
                safeStorage.set('home_inv_v2_history', history);
            }, [items, history]);

            const showMsg = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const addHistory = (itemName, action, amount) => {
                const record = {
                    id: Date.now(),
                    itemName,
                    action,
                    amount,
                    date: new Date().toLocaleString()
                };
                setHistory(prev => [record, ...prev].slice(0, 200));
            };

            const updateQuantity = (id, delta, e) => {
                if (e) e.stopPropagation();
                setItems(prev => prev.map(item => {
                    if (item.id === id) {
                        const newQty = Math.max(0, item.quantity + delta);
                        if (newQty !== item.quantity) {
                            addHistory(item.name, delta > 0 ? '入庫' : '使用', Math.abs(delta));
                            return { ...item, quantity: newQty, lastUpdate: new Date().toLocaleString() };
                        }
                    }
                    return item;
                }));
            };

            // --- AI 功能 ---
            const callGemini = async (prompt, title) => {
                setIsAiLoading(true);
                setAiTitle(title);
                setAiModalOpen(true);
                setAiResult(null);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    setAiResult(data.candidates?.[0]?.content?.parts?.[0]?.text || "無結果");
                } catch (e) {
                    setAiResult("連線失敗，請稍後再試。");
                } finally {
                    setIsAiLoading(false);
                }
            };

            const exportData = () => {
                const data = JSON.stringify({ items, history }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory_backup_${new Date().getTime()}.json`;
                a.click();
                showMsg("備份已下載");
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const { items: newItems, history: newHistory } = JSON.parse(event.target.result);
                        setItems(newItems);
                        setHistory(newHistory);
                        showMsg("匯入成功");
                    } catch (err) { showMsg("檔案格式錯誤"); }
                };
                reader.readAsText(file);
            };

            const filteredItems = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));
            const shoppingList = items.filter(i => i.quantity <= i.minQuantity);

            return (
                <div className="min-h-screen pb-32">
                    <header className="bg-white border-b border-[#E8E2D9] px-6 py-5 sticky top-0 z-30">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Icon name="leaf" className="text-[#8C7E6D]" />
                                <h1 className="text-xl tracking-widest text-[#5D544B]">家用品庫存管理</h1>
                            </div>
                            <div className="flex gap-4">
                                <button onClick={() => fileInputRef.current.click()} className="text-[#A39A90] hover:text-[#8C7E6D]"><Icon name="file-up" size={18} /></button>
                                <button onClick={exportData} className="text-[#A39A90] hover:text-[#8C7E6D]"><Icon name="file-down" size={18} /></button>
                                <input type="file" ref={fileInputRef} className="hidden" onChange={importData} accept=".json" />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-6">
                        {activeTab === 'inventory' && (
                            <div className="animate-in">
                                <div className="flex flex-col md:flex-row gap-4 mb-8">
                                    <div className="relative flex-1">
                                        <Icon name="search" size={16} className="absolute left-0 top-1/2 -translate-y-1/2 text-[#A39A90]" />
                                        <input 
                                            type="text" 
                                            placeholder="搜尋清單..." 
                                            className="w-full bg-transparent border-b border-[#E8E2D9] pl-7 py-2 outline-none font-sans text-sm"
                                            value={searchTerm}
                                            onChange={e => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                    <button onClick={() => setIsModalOpen(true)} className="bg-[#8C7E6D] text-white px-8 py-2 rounded-full text-sm font-sans">新增物品</button>
                                </div>

                                <div className="flex justify-end mb-4 gap-2">
                                    <button 
                                        onClick={() => callGemini(`我有：${items.filter(i=>i.quantity>0).map(i=>i.name).join(',')}, 建議2個簡易食譜`, "✨ 智能食譜建議")}
                                        className="text-[10px] flex items-center gap-1 text-[#C58B7E] font-sans border border-[#C58B7E]/20 px-4 py-1.5 rounded-full hover:bg-white"
                                    >
                                        <Icon name="chef-hat" size={12} /> 智能食譜
                                    </button>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {filteredItems.map(item => (
                                        <div 
                                            key={item.id} 
                                            onClick={() => setDetailItem(item)}
                                            className="bg-white p-6 rounded-lg border border-[#E8E2D9] relative shadow-sm hover:shadow-md transition-all cursor-pointer group"
                                        >
                                            <div className="absolute top-4 right-4 text-[#D1CCC5] group-hover:text-[#8C7E6D]"><Icon name="info" size={14} /></div>
                                            <h3 className="text-xl text-[#5D544B] mb-6">{item.name}</h3>
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-5 font-sans" onClick={e => e.stopPropagation()}>
                                                    <button onClick={(e) => updateQuantity(item.id, -1, e)} className="w-9 h-9 rounded-full border border-[#E8E2D9] flex items-center justify-center text-[#8C7E6D] hover:bg-gray-50"><Icon name="minus" size={14}/></button>
                                                    <div className="text-center min-w-[60px]">
                                                        <span className={`text-3xl font-light ${item.quantity <= item.minQuantity ? 'text-[#C58B7E]' : 'text-[#5D544B]'}`}>{item.quantity}</span>
                                                        <span className="text-xs text-[#A39A90] ml-1">{item.unit}</span>
                                                    </div>
                                                    <button onClick={(e) => updateQuantity(item.id, 1, e)} className="w-9 h-9 rounded-full border border-[#E8E2D9] flex items-center justify-center text-[#8C7E6D] hover:bg-gray-50"><Icon name="plus" size={14}/></button>
                                                </div>
                                                {item.quantity <= item.minQuantity && <span className="text-[10px] text-[#C58B7E] border-b border-[#C58B7E] pb-0.5 tracking-tighter">需補貨</span>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'shopping' && (
                            <div className="animate-in max-w-2xl mx-auto">
                                <h2 className="text-xl text-[#5D544B] mb-8 tracking-widest border-b pb-4">採購建議</h2>
                                {shoppingList.length > 0 && (
                                    <div className="flex justify-end mb-4">
                                        <button 
                                            onClick={() => callGemini(`我需要買：${shoppingList.map(i=>i.name).join(',')}, 請幫我做超市分類並提供3個相關聯建議`, "✨ 智能採購分析")}
                                            className="text-[10px] flex items-center gap-1 text-[#8C7E6D] font-sans border border-[#8C7E6D]/20 px-4 py-1.5 rounded-full hover:bg-white"
                                        >
                                            <Icon name="list-checks" size={12} /> 智能分類建議
                                        </button>
                                    </div>
                                )}
                                <div className="bg-white rounded-lg border border-[#E8E2D9] overflow-hidden divide-y divide-[#F7F5F2]">
                                    {shoppingList.map(item => (
                                        <div key={item.id} className="p-5 flex justify-between items-center">
                                            <div className="flex items-center gap-3">
                                                <div className="w-1.5 h-1.5 rounded-full bg-[#C58B7E]"></div>
                                                <span className="text-lg text-[#5D544B]">{item.name}</span>
                                            </div>
                                            <span className="text-sm font-sans text-[#C58B7E]">剩餘 {item.quantity} {item.unit}</span>
                                        </div>
                                    ))}
                                    {shoppingList.length === 0 && <div className="p-20 text-center text-[#A39A90]">庫存充足，暫無建議。</div>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="animate-in bg-white rounded-lg border border-[#E8E2D9] overflow-hidden divide-y divide-[#F7F5F2]">
                                {history.map(h => (
                                    <div key={h.id} className="p-4 flex justify-between items-center text-sm font-sans">
                                        <div>
                                            <p className="font-bold text-[#5D544B]">{h.itemName}</p>
                                            <p className="text-[10px] text-[#A39A90]">{h.date}</p>
                                        </div>
                                        <span className={`text-[10px] px-3 py-1 rounded-full ${h.action.includes('入庫') ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>{h.action} {h.amount}</span>
                                    </div>
                                ))}
                                {history.length === 0 && <div className="p-20 text-center text-[#A39A90]">尚無紀錄。</div>}
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-[#E8E2D9] h-20 flex justify-around items-center z-40 px-4">
                        <button onClick={() => setActiveTab('inventory')} className={`flex flex-col items-center gap-1 flex-1 ${activeTab === 'inventory' ? 'text-[#8C7E6D]' : 'text-[#D1CCC5]'}`}>
                            <Icon name="layout-dashboard" />
                            <span className="text-[10px] font-sans font-bold">庫存</span>
                        </button>
                        <button onClick={() => setActiveTab('shopping')} className={`flex flex-col items-center gap-1 flex-1 ${activeTab === 'shopping' ? 'text-[#8C7E6D]' : 'text-[#D1CCC5]'}`}>
                            <Icon name="shopping-cart" />
                            <span className="text-[10px] font-sans font-bold">採購</span>
                        </button>
                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center gap-1 flex-1 ${activeTab === 'history' ? 'text-[#8C7E6D]' : 'text-[#D1CCC5]'}`}>
                            <Icon name="history" />
                            <span className="text-[10px] font-sans font-bold">日誌</span>
                        </button>
                    </nav>

                    {/* AI Result Modal */}
                    {aiModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onClick={() => setAiModalOpen(false)}>
                            <div className="bg-white w-full max-w-lg rounded-xl overflow-hidden shadow-2xl flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
                                <div className="p-5 border-b flex justify-between bg-[#FDFCFB] items-center">
                                    <div className="flex items-center gap-2">
                                        <Icon name="sparkles" size={18} className="text-[#C58B7E]" />
                                        <span className="font-bold text-[#5D544B] text-sm">{aiTitle}</span>
                                    </div>
                                    <button onClick={() => setAiModalOpen(false)}><Icon name="x" size={18} /></button>
                                </div>
                                <div className="p-8 overflow-y-auto whitespace-pre-wrap text-sm font-sans leading-relaxed text-[#4A443F]">
                                    {isAiLoading ? (
                                        <div className="flex flex-col items-center py-10 gap-3">
                                            <div className="w-6 h-6 border-2 border-[#8C7E6D] border-t-transparent rounded-full animate-spin"></div>
                                            <span className="text-[10px] uppercase tracking-widest text-[#A39A90]">Gemini 思考中...</span>
                                        </div>
                                    ) : aiResult}
                                </div>
                                <div className="p-4 border-t bg-[#FDFCFB]">
                                    <button onClick={() => setAiModalOpen(false)} className="w-full bg-[#8C7E6D] text-white py-3 rounded-lg text-xs font-bold font-sans">關閉</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Detail Modal */}
                    {detailItem && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm" onClick={() => setDetailItem(null)}>
                            <div className="bg-white w-full max-w-md p-8 rounded-xl shadow-xl" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <p className="text-[10px] font-bold text-[#A39A90] uppercase tracking-widest mb-1">物品備註</p>
                                        <h2 className="text-2xl text-[#5D544B]">{detailItem.name}</h2>
                                    </div>
                                    <button onClick={() => setDetailItem(null)} className="text-[#A39A90] hover:text-black"><Icon name="x" size={24} /></button>
                                </div>
                                <textarea 
                                    className="w-full border border-[#E8E2D9] p-4 text-sm outline-none h-40 resize-none bg-[#FDFCFB] font-sans mb-6 rounded-lg focus:border-[#8C7E6D]"
                                    value={detailItem.notes || ''}
                                    placeholder="輸入備註（如購買地點、保固等）..."
                                    onChange={e => {
                                        const val = e.target.value;
                                        setItems(prev => prev.map(i => i.id === detailItem.id ? {...i, notes: val} : i));
                                        setDetailItem(prev => ({...prev, notes: val}));
                                    }}
                                />
                                <button onClick={() => setDetailItem(null)} className="w-full bg-[#5D544B] py-4 text-white text-xs font-bold rounded-lg font-sans uppercase tracking-widest">儲存並完成</button>
                            </div>
                        </div>
                    )}

                    {/* Add Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40" onClick={() => setIsModalOpen(false)}>
                            <div className="bg-white w-full max-w-sm p-8 rounded-xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-sm font-bold mb-6 text-[#5D544B] border-b pb-2 tracking-widest uppercase">登錄新物品</h3>
                                <div className="space-y-6 font-sans">
                                    <div>
                                        <label className="text-[10px] text-[#A39A90] font-bold tracking-widest">物品名稱</label>
                                        <input className="w-full border-b py-2 outline-none text-sm" onChange={e => setNewItem({...newItem, name: e.target.value})} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] text-[#A39A90] font-bold tracking-widest">初始數量</label>
                                            <input type="number" className="w-full border-b py-2 outline-none text-sm" onChange={e => setNewItem({...newItem, quantity: parseInt(e.target.value) || 0})} />
                                        </div>
                                        <div>
                                            <label className="text-[10px] text-[#A39A90] font-bold tracking-widest">單位</label>
                                            <input className="w-full border-b py-2 outline-none text-sm" placeholder="個/瓶/箱" onChange={e => setNewItem({...newItem, unit: e.target.value})} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-[#C58B7E] font-bold tracking-widest">補貨預警門檻</label>
                                        <input type="number" className="w-full border-b py-2 outline-none text-sm" placeholder="預設 1" onChange={e => setNewItem({...newItem, minQuantity: parseInt(e.target.value) || 1})} />
                                    </div>
                                    <button 
                                        className="w-full bg-[#8C7E6D] text-white py-4 rounded-lg mt-4 font-bold text-xs uppercase tracking-widest"
                                        onClick={() => {
                                            if(!newItem.name) return showMsg("請輸入品名");
                                            const addedItem = { ...newItem, id: Date.now(), lastUpdate: new Date().toLocaleString() };
                                            setItems([...items, addedItem]);
                                            addHistory(newItem.name, '初次登錄', newItem.quantity);
                                            setIsModalOpen(false);
                                            showMsg(`已新增 ${newItem.name}`);
                                        }}
                                    >確認登錄</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {notification && (
                        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 bg-black/80 text-white px-8 py-2.5 rounded-full text-[10px] font-sans z-[100] tracking-widest animate-in">
                            {notification}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>