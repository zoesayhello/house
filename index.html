<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家用品庫存管理系統 (日式簡約版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Serif+TC:wght@500;700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #F9F8F6; /* 日式和紙色 */
            color: #5D544B;
            scroll-behavior: smooth;
        }
        
        .serif-title { font-family: 'Noto Serif TC', serif; }
        
        /* 簡約輸入框 */
        .jp-input { 
            background: transparent;
            border-bottom: 1px solid #E2DED9;
            transition: border-color 0.3s;
        }
        .jp-input:focus { 
            border-color: #8C7E6D;
            outline: none;
        }
        
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 快捷按鈕樣式 */
        .jump-btn {
            font-size: 11px;
            padding: 4px 12px;
            border: 1px solid #E2DED9;
            border-radius: 100px;
            color: #8C8681;
            white-space: nowrap;
            background: white;
            transition: all 0.2s;
        }
        .jump-btn:hover {
            border-color: #8C7E6D;
            color: #8C7E6D;
            background-color: #F3F1EF;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const safeStorage = {
            get: (key, defaultValue) => {
                try {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : defaultValue;
                } catch (e) { return defaultValue; }
            },
            set: (key, value) => {
                try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {}
            }
        };

        const formatUtils = {
            parseTxt: (content) => {
                const inventoryMatch = content.match(/\[INVENTORY_START\]([\s\S]*?)\[INVENTORY_END\]/);
                const historyMatch = content.match(/\[HISTORY_START\]([\s\S]*?)\[HISTORY_END\]/);
                const parseCsvLine = (line) => {
                    const regex = /(".*?"|[^",\s]+)(?=\s*,|\s*$)/g;
                    const matches = line.match(regex);
                    return matches ? matches.map(m => m.replace(/^"|"$/g, '').trim()) : [];
                };
                const items = [];
                if (inventoryMatch) {
                    const lines = inventoryMatch[1].trim().split('\n');
                    for (let i = 1; i < lines.length; i++) {
                        const cols = parseCsvLine(lines[i]);
                        if (cols.length >= 4) {
                            items.push({
                                id: Date.now() + i,
                                name: cols[0],
                                quantity: parseInt(cols[1]) || 0,
                                minQuantity: parseInt(cols[2]) || 0,
                                unit: cols[3],
                                notes: cols[4] || "",
                                lastUpdate: cols[5] || new Date().toLocaleString()
                            });
                        }
                    }
                }
                const history = [];
                if (historyMatch) {
                    const lines = historyMatch[1].trim().split('\n');
                    for (let i = 1; i < lines.length; i++) {
                        const cols = parseCsvLine(lines[i]);
                        if (cols.length >= 4) {
                            history.push({ id: Date.now() + 1000 + i, date: cols[0], itemName: cols[1], action: cols[2], amount: parseInt(cols[3]) || 0 });
                        }
                    }
                }
                return { items, history };
            },
            generateTxt: (items, history) => {
                let output = "[INVENTORY_START]\n名稱,數量,最低警告,單位,備註,最後更新時間\n";
                items.forEach(i => { output += `"${i.name}",${i.quantity},${i.minQuantity},"${i.unit}","${i.notes}","${i.lastUpdate}"\n`; });
                output += "[INVENTORY_END]\n\n[HISTORY_START]\n時間,品名,動作,變動量\n";
                history.forEach(h => { output += `"${h.date}","${h.itemName}","${h.action}",${h.amount}\n`; });
                output += "[HISTORY_END]";
                return output;
            }
        };

        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const App = () => {
            const [items, setItems] = useState([]);
            const [history, setHistory] = useState([]);
            const [activeTab, setActiveTab] = useState('inventory');
            const [searchTerm, setSearchTerm] = useState('');
            const [notification, setNotification] = useState(null);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const fileInputRef = useRef(null);
            const topRef = useRef(null);

            useEffect(() => {
                const data = safeStorage.get('inventory_data_v3', { items: [], history: [] });
                setItems(data.items);
                setHistory(data.history);
            }, []);

            useEffect(() => { safeStorage.set('inventory_data_v3', { items, history }); }, [items, history]);

            const notify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const scrollToTop = () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const scrollToItem = (id) => {
                const el = document.getElementById(`item-${id}`);
                if (el) {
                    const headerOffset = 100;
                    const elementPosition = el.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                    window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
                }
            };

            const updateQty = (id, delta) => {
                setItems(prev => prev.map(item => {
                    if (item.id === id) {
                        const newQty = Math.max(0, item.quantity + delta);
                        if (newQty === item.quantity) return item;
                        const now = new Date().toLocaleString('zh-TW', { hour12: false });
                        setHistory(h => [{id: Date.now(), date: now, itemName: item.name, action: delta > 0 ? "入庫" : "使用", amount: Math.abs(delta)}, ...h].slice(0, 50));
                        return { ...item, quantity: newQty, lastUpdate: now };
                    }
                    return item;
                }));
            };

            const filteredItems = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="min-h-screen pb-32">
                    <div ref={topRef}></div>
                    
                    {/* Header */}
                    <header className="bg-white/90 backdrop-blur-md border-b border-[#EAE7E2] sticky top-0 z-40 px-6 py-5">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <h1 className="serif-title text-xl tracking-[0.3em] text-[#5D544B] font-bold">庫存管理</h1>
                            <div className="flex gap-2">
                                <button onClick={() => fileInputRef.current.click()} className="p-2 text-[#A69F98] hover:text-[#5D544B] transition-colors"><Icon name="upload" size={18} /></button>
                                <button onClick={() => {
                                    const content = formatUtils.generateTxt(items, history);
                                    const blob = new Blob([content], { type: 'text/plain' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `inventory.txt`;
                                    a.click();
                                    notify("已下載備份檔案");
                                }} className="p-2 text-[#A69F98] hover:text-[#5D544B] transition-colors"><Icon name="download" size={18} /></button>
                                <input type="file" ref={fileInputRef} className="hidden" onChange={(e) => {
                                    const file = e.target.files[0];
                                    if (!file) return;
                                    const reader = new FileReader();
                                    reader.onload = (event) => {
                                        const { items: ni, history: nh } = formatUtils.parseTxt(event.target.result);
                                        setItems(ni); setHistory(nh);
                                        notify("資料載入成功");
                                    };
                                    reader.readAsText(file);
                                }} accept=".txt" />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-6">
                        {activeTab === 'inventory' && (
                            <div className="animate-fade-in">
                                {/* Search & Item Jump Bar */}
                                <div className="mb-10">
                                    <div className="relative mb-6">
                                        <Icon name="search" size={14} className="absolute left-0 top-1/2 -translate-y-1/2 text-[#D1CCC5]" />
                                        <input 
                                            type="text" 
                                            placeholder="搜尋項目名稱..." 
                                            className="w-full jp-input pl-6 py-2 text-sm placeholder:text-[#D1CCC5]"
                                            value={searchTerm}
                                            onChange={e => setSearchTerm(e.target.value)}
                                        />
                                    </div>

                                    {/* 項目快速跳轉按鈕 */}
                                    {filteredItems.length > 0 && (
                                        <div className="flex flex-wrap gap-2 overflow-x-auto no-scrollbar py-2">
                                            {filteredItems.map(item => (
                                                <button 
                                                    key={`jump-${item.id}`} 
                                                    onClick={() => scrollToItem(item.id)}
                                                    className="jump-btn"
                                                >
                                                    {item.name}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                    <div className="flex justify-end mt-4">
                                        <button onClick={() => setIsAddModalOpen(true)} className="text-[12px] text-[#8C7E6D] border border-[#8C7E6D]/30 px-4 py-1.5 rounded hover:bg-[#8C7E6D] hover:text-white transition-all">
                                            ＋ 新增項目
                                        </button>
                                    </div>
                                </div>

                                {/* Items List */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-12">
                                    {filteredItems.map(item => (
                                        <div key={item.id} id={`item-${item.id}`} className="group flex flex-col border-b border-[#EAE7E2] pb-8 transition-all">
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="flex-1">
                                                    <h3 className="text-[15px] font-medium text-[#4A443F] tracking-wide">{item.name}</h3>
                                                    <p className="text-[10px] text-[#A69F98] mt-1 font-sans">Update: {item.lastUpdate.split(' ')[0]}</p>
                                                </div>
                                                {item.quantity <= item.minQuantity && (
                                                    <span className="text-[9px] text-[#C58B7E] px-2 py-0.5 border border-[#C58B7E]/20 rounded tracking-tighter">補充建議</span>
                                                )}
                                            </div>
                                            
                                            <div className="flex items-center justify-between mt-auto">
                                                <div className="flex items-center gap-6">
                                                    <button onClick={() => updateQty(item.id, -1)} className="text-[#A69F98] hover:text-[#55514E]"><Icon name="minus" size={16}/></button>
                                                    <div className="flex items-baseline gap-1 min-w-[50px] justify-center font-sans">
                                                        <span className="text-2xl font-light text-[#55514E]">{item.quantity}</span>
                                                        <span className="text-[11px] text-[#A69F98]">{item.unit}</span>
                                                    </div>
                                                    <button onClick={() => updateQty(item.id, 1)} className="text-[#A69F98] hover:text-[#55514E]"><Icon name="plus" size={16}/></button>
                                                </div>

                                                {/* 回到頂端選項 */}
                                                <button 
                                                    onClick={scrollToTop}
                                                    className="text-[10px] text-[#D1CCC5] hover:text-[#8C7E6D] flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                                >
                                                    <Icon name="chevron-up" size={12} /> 回到頂端
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                    {filteredItems.length === 0 && (
                                        <div className="col-span-full py-20 text-center text-[#D1CCC5] text-sm italic tracking-widest">
                                            無匹配項目
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'shopping' && (
                            <div className="animate-fade-in max-w-xl mx-auto">
                                <h2 className="serif-title text-base mb-10 tracking-[0.3em] border-l-2 border-[#C58B7E] pl-4">補貨建議清單</h2>
                                <div className="space-y-px">
                                    {items.filter(i => i.quantity <= i.minQuantity).map(item => (
                                        <div key={item.id} className="bg-white p-6 flex justify-between items-center border-b border-[#F5F3F0]">
                                            <span className="text-[14px] text-[#55514E]">{item.name}</span>
                                            <span className="text-[11px] text-[#C58B7E] font-sans">剩餘 {item.quantity} {item.unit}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="animate-fade-in max-w-xl mx-auto">
                                <h2 className="serif-title text-base mb-10 tracking-[0.3em] border-l-2 border-[#8C7E6D] pl-4">庫存異動日誌</h2>
                                <div className="space-y-6">
                                    {history.map(h => (
                                        <div key={h.id} className="flex justify-between items-center border-b border-[#EAE7E2] pb-4">
                                            <div>
                                                <p className="text-[13px] text-[#55514E]">{h.itemName}</p>
                                                <p className="text-[9px] text-[#D1CCC5] font-sans uppercase">{h.date}</p>
                                            </div>
                                            <span className={`text-[11px] font-medium tracking-tighter ${h.action === '入庫' ? 'text-[#8C7E6D]' : 'text-[#C58B7E]'}`}>
                                                {h.action} {h.amount}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Navigation */}
                    <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-[#55514E]/95 text-white px-10 py-4 rounded-full flex gap-12 shadow-2xl backdrop-blur-sm z-50">
                        <button onClick={() => setActiveTab('inventory')} className={`flex flex-col items-center transition-all ${activeTab === 'inventory' ? 'scale-110 text-white' : 'text-white/30'}`}>
                            <Icon name="box" size={18} />
                            <span className="text-[9px] mt-1 tracking-widest font-bold">庫存</span>
                        </button>
                        <button onClick={() => setActiveTab('shopping')} className={`flex flex-col items-center transition-all ${activeTab === 'shopping' ? 'scale-110 text-white' : 'text-white/30'}`}>
                            <Icon name="shopping-bag" size={18} />
                            <span className="text-[9px] mt-1 tracking-widest font-bold">補貨</span>
                        </button>
                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center transition-all ${activeTab === 'history' ? 'scale-110 text-white' : 'text-white/30'}`}>
                            <Icon name="clock" size={18} />
                            <span className="text-[9px] mt-1 tracking-widest font-bold">日誌</span>
                        </button>
                    </nav>

                    {/* Modal */}
                    {isAddModalOpen && (
                        <div className="fixed inset-0 z-[60] bg-white/60 backdrop-blur-sm flex items-center justify-center p-6 animate-fade-in" onClick={() => setIsAddModalOpen(false)}>
                            <div className="bg-white w-full max-w-sm p-10 border border-[#EAE7E2] shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="serif-title text-center text-lg mb-12 tracking-[0.2em]">項目登錄</h3>
                                <div className="space-y-10">
                                    <div className="relative">
                                        <label className="text-[10px] text-[#A69F98] absolute -top-5 tracking-widest">NAME / 名稱</label>
                                        <input id="new-name" placeholder="輸入名稱" className="w-full jp-input py-2 text-sm" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-10">
                                        <div className="relative">
                                            <label className="text-[10px] text-[#A69F98] absolute -top-5 tracking-widest">QTY / 數量</label>
                                            <input id="new-qty" type="number" placeholder="0" className="w-full jp-input py-2 text-sm" />
                                        </div>
                                        <div className="relative">
                                            <label className="text-[10px] text-[#A69F98] absolute -top-5 tracking-widest">UNIT / 單位</label>
                                            <input id="new-unit" placeholder="個" className="w-full jp-input py-2 text-sm" />
                                        </div>
                                    </div>
                                    <div className="relative">
                                        <label className="text-[10px] text-[#A69F98] absolute -top-5 tracking-widest">ALERT / 警戒</label>
                                        <input id="new-min" type="number" placeholder="1" className="w-full jp-input py-2 text-sm" />
                                    </div>
                                    <div className="flex gap-4 pt-8">
                                        <button onClick={() => setIsAddModalOpen(false)} className="flex-1 py-3 text-[12px] text-[#A69F98]">取消</button>
                                        <button 
                                            className="flex-1 py-3 bg-[#55514E] text-white text-[12px] tracking-widest"
                                            onClick={() => {
                                                const n = document.getElementById('new-name').value;
                                                if(!n) return;
                                                const q = parseInt(document.getElementById('new-qty').value) || 0;
                                                const u = document.getElementById('new-unit').value || "個";
                                                const m = parseInt(document.getElementById('new-min').value) || 1;
                                                const now = new Date().toLocaleString('zh-TW', { hour12: false });
                                                setItems([{id: Date.now(), name: n, quantity: q, unit: u, minQuantity: m, notes: "", lastUpdate: now}, ...items]);
                                                setIsAddModalOpen(false);
                                                notify(`已登錄：${n}`);
                                            }}
                                        >確認登錄</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {notification && (
                        <div className="fixed top-24 left-1/2 -translate-x-1/2 bg-[#55514E] text-white px-8 py-2 text-[11px] tracking-widest rounded shadow-xl z-[100] animate-fade-in">
                            {notification}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>